<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8"/>
	<title>Uxntal Playground</title>
	<script src="src/programs.js"></script>
	<script src="src/emu.js"></script>
	<script src="src/uxn.js"></script>
</head>
<body>
	<textarea id="editor" spellcheck="false">Program</textarea>
	<div id='term'></div>
	<div id='stack'>
		<input type="button" id="run" value="Run">
		<span id='wst'>empty</span>
	</div>

	<script type="text/javascript">
		'use strict'

		let term_el = document.getElementById("term")
		term_el.innerHTML = "Ready."

		let editor_el = document.getElementById("editor")
		editor_el.value = hello_tal;

		let wst_el = document.getElementById("wst")
		wst_el.innerHTML = "--"

		function assemble(query, program){
			let emulator = new Emu()
			let length = 0
			emulator.console.write = (char) => { program[length++] = char }
			emulator.console.error = (char) => { term_el.innerHTML += String.fromCharCode(char) }
			emulator.uxn.load(drifloon_rom).eval(0x0100)
			term_el.innerHTML = ""
			for (let i = 0; i < query.length; i++)
				emulator.console.input(query.charAt(i).charCodeAt(0))
			emulator.console.input(0x0a)
		}

		/* assembler */
		let run_el = document.getElementById("run")		
		run_el.addEventListener("click", (event) => {
			let program = new Uint8Array(0x10000)
			assemble(editor_el.value.replace(/(\r\n|\n|\r|\t)/gm, " "), program)
			let emulator = new Emu()
			emulator.console.write = (char) => { term_el.innerHTML += String.fromCharCode(char) }
			emulator.uxn.load(program).eval(0x0100)
			/* draw stack */
			if(!emulator.uxn.wst.ptr())
				wst_el.innerHTML = "Stack: Empty"
			else {
				let i = 0;
				wst_el.innerHTML = "Stack: "
				for(i = 0; i< emulator.uxn.wst.ptr(); i++){
					wst_el.innerHTML += ('0' + (emulator.uxn.wst.get(i) & 0xFF).toString(16)).slice(-2) + " ";
				}
			}
			
		})
	</script>
	<style>
		body { max-width:600px; font-family:monospace; padding:30px }
		textarea { resize:none; width:100%; height:275px; border:2px solid #000; border-radius:0px; padding:10px; margin-bottom:0px; }
		textarea:focus { outline: none !important; border:2px solid black; }
		div#term { width:100%; background:#000; padding:12px; color:white; max-height:60px; overflow:scroll; white-space:pre }
		div#ctrl { margin-bottom:10px }
		div#stack { width:100%; background:#72dec2; padding:12px; margin-bottom:20px;font-weight:bold }
	</style>
	<noscript>This form requires Javascript.</noscript>
</body>
</html> 